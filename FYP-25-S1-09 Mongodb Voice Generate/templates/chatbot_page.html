{% extends "base.html" %}

{% block title %}Chat with EduMate{% endblock %}

{% block content %}
<style>
    #sidebar-wrapper {
        transition: all 0.3s ease;
        width: 300px;
        padding: 20px;
        background-color: #f8f9fa;
        
    }

    #sidebar-wrapper.collapsed {
        width: 0 !important;
        padding: 0 !important;
        overflow: hidden;
        margin-right: 0;
    }

    #toggle-sidebar {
        position: absolute;
        top: 10px;
        left: 300px;
        z-index: 1000;
        transition: left 0.3s ease;
    }

    #toggle-sidebar.collapsed {
        left: 0;
    }

    .chat-item {
        transition: background-color 0.2s;
    }

    .chat-item:hover {
        background-color: #e9ecef;
    }

    .chat-item.active {
        background-color: #d1e7ff;
    }

    .message-user {
        background-color: #e3f2fd;
        border-radius: 15px 15px 0 15px;
        padding: 8px 12px;
        margin: 5px 0;
        max-width: 80%;
        margin-left: auto;
    }

    .message-bot {
        background-color: #f8f9fa;
        border-radius: 15px 15px 15px 0;
        padding: 8px 12px;
        margin: 5px 0;
        max-width: 80%;
        margin-right: auto;
        border: 1px solid #eee;
    }

    #chat-box {
        min-height: 400px;
        display: flex;
        flex-direction: column;
    }

    .new-chat-btn {
        margin-bottom: 10px;
    }

    .avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 10px;
    }

    .user-avatar {
        margin-left: 10px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        position: absolute;
        right: 0;
    }


    .message-row {
        display: flex;
        align-items: flex-start;
        margin-bottom: 8px;
    }

    .message-row.user {
        justify-content: flex-end;
        padding-right:10px;
    }

    .message-row.bot {
        justify-content: flex-start;
    }
</style>

<div class="container mt-4">
    <div class="d-flex position-relative" id="chat-container">
        <!-- Sidebar -->
        <div id="sidebar-wrapper" class="pe-3">
            <div class="card shadow h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Chats</h5>
                    <input type="text" id="chat-search" class="form-control mb-2" placeholder="Search chats...">
                    <button id="new-chat-btn" class="btn btn-sm btn-primary new-chat-btn">
                        <i class="fas fa-plus"></i> New
                    </button>
                </div>
                <div class="card-body p-0" style="height: 400px; overflow-y: auto;">
                    <div id="chat-list" class="list-group list-group-flush">
                        {% for chat in chatbot_chats %}
                            <div class="chat-item list-group-item list-group-item-action" 
                                 data-chat-id="{{ chat._id }}" 
                                 data-title="{{ chat.title }}">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ chat.title }}</h6>
                                </div>
                                <p class="mb-1 text-truncate">{{ chat.description|default('') }}</p>
                            </div>
                        {% endfor %}
                        {% if not chatbot_chats %}
                            <div class="text-center p-3 text-muted">
                                No chats available. Start a new chat!
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Toggle Sidebar Button -->
        <button id="toggle-sidebar" class="btn btn-sm btn-outline-secondary" title="Toggle sidebar">
            <i class="fas fa-chevron-left"></i>
        </button>

        <!-- Main Chat Area -->
        <div class="flex-grow-1" id="main-chat">
            <div class="card shadow h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1 overflow-hidden">
                        <h5 id="chat-title" class="mb-0 text-truncate" contenteditable="true" spellcheck="false" title="Click to edit chat title">Select a chat or start a new one</h5>
                    </div>
                    <div id="chat-actions" class="ms-2 d-none">
                        <button id="delete-chat-btn" class="btn btn-sm btn-outline-danger" title="Delete chat">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-3" id="chat-box" style="height: 400px; overflow-y: auto;">
                    <div id="welcome-message" class="text-center text-muted h-100 d-flex flex-column justify-content-center">
                        <i class="fas fa-comments fa-4x mb-3"></i>
                        <h4>Welcome to EduMate!</h4>
                        <p>Select a chat from the sidebar or start a new conversation</p>
                    </div>
                    <div id="messages-container" class="d-none"></div>
                </div>
                <div class="card-footer">
                    <form id="chat-form" class="d-flex">
                        <input type="text" id="message-input" class="form-control me-2" 
                               placeholder="Type your message..." required disabled>
                        <button type="submit" class="btn btn-primary" disabled>
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const messagesContainer = document.getElementById('messages-container');
    const welcomeMessage = document.getElementById('welcome-message');
    const chatList = document.getElementById('chat-list');
    const sidebar = document.getElementById('sidebar-wrapper');
    const toggleBtn = document.getElementById('toggle-sidebar');
    const newChatBtn = document.getElementById('new-chat-btn');
    const deleteChatBtn = document.getElementById('delete-chat-btn');
    const chatTitle = document.getElementById('chat-title');
    const chatActions = document.getElementById('chat-actions');
    
    let currentChatId = null;
    let isLoading = false;

    // Initialize sidebar state
    const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    if (sidebarCollapsed) {
        sidebar.classList.add('collapsed');
        toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        toggleBtn.classList.add('collapsed');
    }

    // Toggle sidebar
    toggleBtn.addEventListener('click', () => {
        const isCollapsed = sidebar.classList.toggle('collapsed');
        localStorage.setItem('sidebarCollapsed', isCollapsed);
        toggleBtn.innerHTML = isCollapsed 
            ? '<i class="fas fa-chevron-right"></i>' 
            : '<i class="fas fa-chevron-left"></i>';
        toggleBtn.classList.toggle('collapsed', isCollapsed);
    });

    // Create a new chat
    newChatBtn.addEventListener('click', async () => {
        try {
            const response = await fetch('/api/chat/new', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ title: 'New Chat' })
            });
            
            if (!response.ok) throw new Error('Failed to create chat');
            
            const data = await response.json();
            loadChat(data.chat_id, data.title);
            
            // Add to sidebar
            const now = new Date();
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item list-group-item list-group-item-action active';
            chatItem.dataset.chatId = data.chat_id;
            chatItem.dataset.title = data.title;
            chatItem.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${data.title}</h6>
                    <small class="text-muted">${now.toLocaleTimeString()}</small>
                </div>
                <p class="mb-1 text-truncate">New chat started</p>
            `;
            
            // Insert at top of list
            if (chatList.firstChild) {
                chatList.insertBefore(chatItem, chatList.firstChild);
            } else {
                chatList.appendChild(chatItem);
            }
            
            // Set active state
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            chatItem.classList.add('active');
            
        } catch (error) {
            console.error('Error creating new chat:', error);
            alert('Failed to create new chat. Please try again.');
        }
    });

    // Delete current chat
    deleteChatBtn.addEventListener('click', async () => {
        if (!currentChatId || !confirm('Are you sure you want to delete this chat?')) return;
        
        try {
            const response = await fetch(`/api/chat/${currentChatId}/delete`, {
                method: 'DELETE'
            });
            
            if (!response.ok) throw new Error('Failed to delete chat');
            
            // Remove from sidebar
            document.querySelector(`.chat-item[data-chat-id="${currentChatId}"]`)?.remove();
            
            // Reset UI
            resetChatUI();
            
        } catch (error) {
            console.error('Error deleting chat:', error);
            alert('Failed to delete chat. Please try again.');
        }
    });

    // Load chat messages
    async function loadChat(chatId, title) {
        try {
            isLoading = true;
            currentChatId = chatId;
            
            // Update UI
            chatTitle.textContent = title;
            chatActions.classList.remove('d-none');
            welcomeMessage.classList.add('d-none');
            messagesContainer.classList.remove('d-none');
            messageInput.disabled = false;
            chatForm.querySelector('button').disabled = false;
            
            // Clear existing messages
            messagesContainer.innerHTML = '';
            
            // Fetch messages from server
            const response = await fetch(`/api/chat/${chatId}/messages`);
            if (!response.ok) throw new Error('Failed to load chat');
            
            const data = await response.json();
            
            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    appendMessage('user', msg.user);
                    appendMessage('bot', msg.bot);
                });
            } else {
                appendMessage('bot', 'Hello! How can I help you with your studies today?');
            }
            
            scrollToBottom();
            
        } catch (error) {
            console.error('Error loading chat:', error);
            alert('Failed to load chat. Please try again.');
        } finally {
            isLoading = false;
        }
    }

    // Reset chat UI when no chat is selected
    function resetChatUI() {
        currentChatId = null;
        chatTitle.textContent = 'Select a chat or start a new one';
        chatActions.classList.add('d-none');
        welcomeMessage.classList.remove('d-none');
        messagesContainer.classList.add('d-none');
        messagesContainer.innerHTML = '';
        messageInput.disabled = true;
        chatForm.querySelector('button').disabled = true;
    }

    // Append message to chat
    function appendMessage(sender, message, username) {
        const messageRow = document.createElement('div');
        messageRow.className = `message-row ${sender}`;

        const messageDiv = document.createElement('div');
        messageDiv.className = `message-${sender}`;
        messageDiv.innerHTML = message;

        if (sender === 'bot') {
            const botAvatar = document.createElement('img');
            botAvatar.src = '/static/images/chat-icon-for-edumate.png'; // Replace with your bot icon path
            botAvatar.alt = 'Bot Avatar';
            botAvatar.className = 'avatar';

            messageRow.appendChild(botAvatar);
            messageRow.appendChild(messageDiv);
        } else if (sender === 'user') {
            // Dynamically load user avatar from Flask route using the username
            const userAvatar = document.createElement('img');
            userAvatar.src = "{{ url_for('boundary.get_profile_pic', username=session['username']) }}"; // This will fetch the user's avatar from the Flask route
            userAvatar.alt = 'User Avatar';
            userAvatar.className = 'user-avatar';

            messageRow.appendChild(userAvatar);
            messageRow.appendChild(messageDiv);
        }

        messagesContainer.appendChild(messageRow);
        scrollToBottom();
    }


    // Scroll to bottom of chat
    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Handle chat form submission
    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (!message || !currentChatId || isLoading) return;
        
        // Add user message to UI immediately
        appendMessage('user', message);
        messageInput.value = '';
        
        try {
            isLoading = true;
            messageInput.disabled = true;
            
            const response = await fetch(`/api/chat/${currentChatId}/send`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message })
            });
            
            if (!response.ok) throw new Error('Failed to send message');
            
            const data = await response.json();
            appendMessage('bot', data.reply);
            
            // Update the chat item in sidebar with new description
            const chatItem = document.querySelector(`.chat-item[data-chat-id="${currentChatId}"]`);
            if (chatItem) {
                const desc = chatItem.querySelector('p.mb-1');
                if (desc) {
                    desc.textContent = message.length > 50 ? message.substring(0, 47) + '...' : message;
                }
            }
            
        } catch (error) {
            console.error('Error sending message:', error);
            appendMessage('bot', 'Sorry, I encountered an error. Please try again.');
        } finally {
            isLoading = false;
            messageInput.disabled = false;
            messageInput.focus();
        }
    });

    // Load chat when clicking on sidebar item
    chatList.addEventListener('click', (e) => {
        let chatItem = e.target.closest('.chat-item');
        if (!chatItem) return;
        
        const chatId = chatItem.dataset.chatId;
        const title = chatItem.dataset.title;
        
        // Set active state
        document.querySelectorAll('.chat-item').forEach(item => {
            item.classList.remove('active');
        });
        chatItem.classList.add('active');
        
        loadChat(chatId, title);
    });

    // Enable pressing Enter to send message (but allow Shift+Enter for new lines)
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatForm.dispatchEvent(new Event('submit'));
        }
    });
    document.getElementById('chat-search').addEventListener('input', function () {
    const query = this.value.toLowerCase();
    document.querySelectorAll('.chat-item').forEach(item => {
        const title = item.dataset.title.toLowerCase();
        item.style.display = title.includes(query) ? '' : 'none';
    });
});
let originalTitle = '';

chatTitle.addEventListener('focus', () => {
    originalTitle = chatTitle.textContent.trim();
});

chatTitle.addEventListener('blur', async () => {
    const newTitle = chatTitle.textContent.trim();

    if (!currentChatId || newTitle === '' || newTitle === originalTitle) {
        chatTitle.textContent = originalTitle; // Revert if no change or blank
        return;
    }

    try {
        const response = await fetch(`/api/chat/${currentChatId}/update_title`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: newTitle })
        });

        if (!response.ok) throw new Error('Update failed');

        // Update sidebar title
        const sidebarItem = document.querySelector(`.chat-item[data-chat-id="${currentChatId}"]`);
        if (sidebarItem) {
            const titleEl = sidebarItem.querySelector('h6');
            if (titleEl) titleEl.textContent = newTitle;
            sidebarItem.dataset.title = newTitle;
        }

        originalTitle = newTitle;

    } catch (error) {
        console.error('Error updating title:', error);
        alert('Failed to update chat title. Try again.');
        chatTitle.textContent = originalTitle;
    }
});

// Save on Enter
chatTitle.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        chatTitle.blur(); // Triggers blur event
    }
});
});


</script>

<script type="text/javascript" async
src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
{% endblock %}