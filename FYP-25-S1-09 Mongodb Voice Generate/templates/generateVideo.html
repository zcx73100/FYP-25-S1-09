{% extends "base.html" %}
{% block title %}Generate Video{% endblock %}
{% block content %}
<div class="container py-5">
  <h2 class="text-center mb-4">ğŸ¬ Create Animated Video</h2>

  <!-- Error Message -->
  <div class="alert alert-danger text-center" id="error-message" style="display: none;"></div>

  <!-- Debug Info -->
  <div class="alert alert-secondary" style="font-size: 0.9em;">
    <strong>Debug Info:</strong><br>
    Session Role: <code>{{ session.get("role") }}</code><br>
    Source Param: <code>{{ request.args.get("source") }}</code><br>
    Classroom ID: <code>{{ request.args.get("classroom_id") }}</code><br>
    Assignment ID: <code>{{ request.args.get("assignment_id") }}</code>
  </div>

  <!-- Voice Generation -->
  <div class="mb-3">
    <label for="text">Enter Text for Animation (or leave blank if using a saved voice):</label>
    <textarea id="text" name="text" class="form-control" rows="3"></textarea>
    <button type="button" id="generateVoice" class="btn btn-warning w-100 my-2">ğŸ”Š Generate Voice</button>
    <audio id="audioPreview" controls style="display:none; width:100%;"></audio>
    <input type="hidden" id="audio_id" name="audio_id">
  </div>

  <form id="videoForm" class="card p-4 shadow">
    <!-- Saved Voices -->
    <div class="mb-3">
      <label class="form-label">ğŸµ Select audio from your saved voices:</label>
      {% if voice_records %}
        {% for record in voice_records %}
          <div class="form-check">
            <input class="form-check-input" type="radio" name="audio_choice" value="{{ record.audio_id }}" id="voice{{ loop.index }}">
            <label class="form-check-label" for="voice{{ loop.index }}">
              {{ record.text or "Voice " ~ loop.index }}
            </label>
          </div>
        {% endfor %}
      {% else %}
        <p class="text-danger">No voice records available.</p>
      {% endif %}
    </div>

    <!-- Avatar Selection -->
    <div class="mb-3">
      <label class="form-label">ğŸ–¼ï¸ Select an Avatar:</label>
      <div class="d-flex flex-wrap gap-3">
        {% for avatar in avatars %}
          <label class="text-center">
            <input type="radio" name="avatar_id" value="{{ avatar._id }}" required>
            <img src="data:image/png;base64,{{ avatar.image_data }}" class="img-thumbnail" style="width:100px; height:100px;">
            <p>{{ avatar.avatarname }}</p>
          </label>
        {% endfor %}
      </div>
    </div>

    <button type="submit" class="btn btn-primary w-100">ğŸ¥ Generate Video</button>

    <!-- Progress Bar -->
    <div id="progress-container" style="display:none;" class="mt-3">
      <label>Video Generation Progress:</label>
      <div class="progress">
        <div id="progress-bar" class="progress-bar" style="width: 0%;" role="progressbar">0%</div>
      </div>
      <div id="progress-status" class="text-center mt-2 fw-bold"></div>
    </div>
  </form>

  <!-- Video Preview -->
  <div id="video-preview" class="text-center mt-4"></div>

  <!-- Teacher: Publish Assignment -->
  {% if session.get("role") == "Teacher" and request.args.get("source") == "assignment" %}
  <div id="publish-section" class="text-center mt-3" style="display: none;">
    <form id="publishAssignmentForm" class="mt-3">
      <input type="hidden" name="video_id" id="videoIdInput">
      <input type="hidden" name="classroom_id" value="{{ request.args.get('classroom_id') }}">
      <button type="submit" class="btn btn-warning w-100">ğŸ“¢ Publish to Assignment</button>
    </form>
  </div>
  {% endif %}

  <!-- Student: Submit Video Assignment -->
  {% if session.get("role") == "Student" and request.args.get("source") == "submission" %}
    <!-- keep assignmentIdInput -->
    <input type="hidden" id="assignmentIdInput" value="{{ request.args.get('assignment_id') }}">
    <!-- add this so JS can read the video ID -->
    <input type="hidden" id="videoIdInput" value="">

    <div id="submit-section" class="text-center mt-3" style="display: none;">
      <button id="submitVideoAssignment" class="btn btn-success w-100">ğŸ“¤ Submit Video</button>
    </div>
  {% endif %}
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const audioIdInput       = document.getElementById("audio_id");
    const audioPreview       = document.getElementById("audioPreview");
    const errorMsg           = document.getElementById("error-message");
    const videoForm          = document.getElementById("videoForm");
    const videoPreview       = document.getElementById("video-preview");
    const progressBar        = document.getElementById("progress-bar");
    const statusLabel        = document.getElementById("progress-status");
    const publishSection     = document.getElementById("publish-section");
    const submitSection      = document.getElementById("submit-section");
    const videoIdInput       = document.getElementById("videoIdInput");
    const assignmentIdInput  = document.getElementById("assignmentIdInput");

    // Voice generation
    document.getElementById("generateVoice").addEventListener("click", () => {
      const text = document.getElementById("text").value.trim();
      if (!text) return alert("âš  Please enter text for voice generation!");
      fetch("/generate_voice", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          audioIdInput.value = data.audio_id;
          audioPreview.src    = `/stream_audio/${data.audio_id}`;
          audioPreview.style.display = "block";
          document.querySelectorAll("input[name='audio_choice']").forEach(el => el.checked = false);
        } else {
          alert("âŒ Voice generation failed: " + data.error);
        }
      });
    });

    // Selecting saved voice
    document.querySelectorAll("input[name='audio_choice']").forEach(radio => {
      radio.addEventListener("change", function () {
        audioIdInput.value = this.value;
        audioPreview.src   = `/stream_audio/${this.value}`;
        audioPreview.style.display = "block";
      });
    });

    // Video form submission
    videoForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const text    = document.getElementById("text").value.trim();
      const avatar  = document.querySelector("input[name='avatar_id']:checked");
      const audioId = audioIdInput.value.trim();
      if (!audioId || !avatar) {
        errorMsg.innerText = "âŒ Please select an avatar and a voice.";
        errorMsg.style.display = "block";
        return;
      }
      errorMsg.style.display = "none";

      const formData = new FormData();
      formData.append("text", text);
      formData.append("avatar_id", avatar.value);
      formData.append("audio_id", audioId);

      // reset progress UI
      progressBar.style.width = "0%";
      progressBar.textContent = "0%";
      statusLabel.innerText   = "â³ Starting...";
      document.getElementById("progress-container").style.display = "block";

      fetch("/generate_video", { method: "POST", body: formData })
      .then(res => res.json())
      .then(data => {
        if (!data.success) {
          errorMsg.innerText = "âŒ " + (data.error || "Video generation failed.");
          errorMsg.style.display = "block";
          return;
        }
        const vid = data.video_id;
        videoIdInput.setAttribute("value", vid);

        return fetch("/save_generated_video", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, avatar_id: avatar.value, audio_id: audioId, video_id: vid })
        }).then(() => {
          videoPreview.innerHTML =
            `<video width="400" controls autoplay>
               <source src="/stream_video/${vid}" type="video/mp4">
               Your browser does not support the video tag.
             </video>`;
          progressBar.style.width = "100%";
          progressBar.textContent = "100%";
          statusLabel.innerText   = "âœ… Completed";

          if (publishSection) publishSection.style.display = "block";
          if (submitSection)  submitSection.style.display  = "block";
        });
      });
    });

    // Publish to assignment (teacher)
    document.getElementById("publishAssignmentForm")?.addEventListener("submit", function(e) {
      e.preventDefault();
      const cid = `{{ request.args.get('classroom_id') }}`;
      fetch("/publish_assignment_video", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ video_id: videoIdInput.value, classroom_id: cid })
      })
      .then(r => r.json())
      .then(resp => {
        if (resp.success) location.href = `/teacher/upload_assignment/${cid}`;
        else alert("âŒ Publish failed: " + resp.error);
      });
    });

    // Submit video as assignment (student)
    document.getElementById("submitVideoAssignment")?.addEventListener("click", function() {
      const vid = document.getElementById("videoIdInput").value;
      const aid = assignmentIdInput.value;
      fetch(`/submit_video_assignment/${aid}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ video_id: vid })
      })
      .then(r => r.json())
      .then(resp => {
        if (resp.success) location.href = `/student/view_submission/${aid}`;
        else alert("âŒ Submission failed: " + resp.message);
      });
    });
  });
</script>
{% endblock %}
