{% extends "base.html" %}
{% block content %}

<div class="assignment-view-container">
  <h2 class="mb-3">ğŸ“˜ Assignment: {{ assignment.title }}</h2>

  <!-- Meta Info -->
  <div class="assignment-meta">
    {% if assignment.description %}
      <p><strong>Description:</strong> {{ assignment.description }}</p>
    {% endif %}
    {% if assignment.due_date %}
      <p><strong>Due Date:</strong> {{ assignment.due_date.strftime('%d %B %Y, %I:%M %p') }}</p>
    {% endif %}
  </div>

  <!-- ğŸ¥ Instructional Video (from teacher) -->
  {% if assignment.video_id %}
    <div class="video-preview my-4">
      <h4>ğŸ¥ Instructional Video</h4>
      <video class="rounded shadow w-full max-w-md" controls>
        <source src="{{ url_for('boundary.stream_video', video_id=assignment.video_id) }}" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </div>
  {% endif %}

  <!-- ğŸ“‚ File or Video Preview -->
  <div class="assignment-frame mt-4">
    {% if student_submission and student_submission.video_id %}
      <h4>ğŸ¬ Your Submitted Video</h4>
      <video class="rounded shadow w-full max-w-md" controls>
        <source src="{{ url_for('boundary.stream_video', video_id=student_submission.video_id) }}" type="video/mp4">
        Your browser does not support the video tag.
      </video>

    {% elif file_extension == "pdf" %}
      <iframe src="data:application/pdf;base64,{{ file_base64 }}" width="100%" height="600px" frameborder="0"></iframe>

    {% elif file_extension in ["txt", "md"] %}
      <div class="text-content">
        <pre>{{ text_content | e }}</pre>
      </div>

    {% elif file_extension in ["doc", "docx", "ppt", "pptx"] %}
      <p>This file type cannot be previewed. Please download it below.</p>

    {% else %}
      <p>No submission preview available.</p>
    {% endif %}
  </div>

  <!-- ğŸ“Š Grade + Feedback -->
  {% if student_submission and student_submission.grade is not none %}
    <div class="grade-feedback-box mt-4 p-4">
      <h4>ğŸ“Š Your Grade</h4>
      <p><strong>Score:</strong> {{ student_submission.grade }} / 100</p>
      <p><strong>Grade:</strong>
        {% if student_submission.grade >= 85 %} HD
        {% elif student_submission.grade >= 75 %} D
        {% elif student_submission.grade >= 65 %} C
        {% elif student_submission.grade >= 50 %} P
        {% else %} F
        {% endif %}
      </p>

      {% if student_submission.feedback %}
        <div class="mt-3">
          <strong>ğŸ“ Feedback:</strong>
          <p class="feedback-content">{{ student_submission.feedback }}</p>
        </div>
      {% endif %}
    </div>
  {% endif %}

  <!-- ğŸ‘¨â€ğŸ“ Student Submission Options -->
  {% if session.get('role') == 'Student' %}
    <div class="submission-section mt-5">
      {% if student_submission %}
        <p class="text-white"><strong>You have already submitted this assignment.</strong></p>
        <div class="mt-3 flex flex-col gap-2">
          <a href="{{ url_for('boundary.student_view_submission', submission_id=student_submission._id) }}" class="btn btn-success">ğŸ“„ View Submission</a>
          <a href="{{ url_for('boundary.student_edit_submission', submission_id=student_submission._id) }}" class="btn btn-warning">âœï¸ Edit Submission</a>
          <form action="{{ url_for('boundary.student_delete_submission', submission_id=student_submission._id, assignment_id=assignment._id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete your submission?');">
            <button type="submit" class="btn btn-danger">ğŸ—‘ï¸ Delete Submission</button>
          </form>
        </div>
      {% else %}
        <div class="mb-4 text-left text-white">
          <label class="block text-sm font-semibold mb-2">ğŸ¯ Choose Submission Type:</label>
          <div class="flex gap-4">
            <label><input type="radio" id="submit-file" name="submit_type" checked> ğŸ“„ Upload File</label>
            <label><input type="radio" id="submit-video" name="submit_type"> ğŸ¥ Generate Video</label>
          </div>
        </div>

        <!-- File Upload -->
        <form id="file-form" action="{{ url_for('boundary.submit_assignment', assignment_id=assignment._id, filename=filename) }}" method="POST" enctype="multipart/form-data">
          <label for="file-upload" class="text-white">Choose file:</label>
          <input type="file" name="file" id="file-upload" required class="w-full p-2 bg-white text-black rounded">
          <input type="hidden" name="assignment_id" value="{{ assignment._id }}">
          <input type="hidden" name="student_username" value="{{ session['username'] }}">
          <button type="submit" class="btn btn-primary mt-3 w-full">ğŸ“¤ Submit File</button>
        </form>

        <!-- Generate Video -->
        <form id="video-form" action="{{ url_for('boundary.generate_video') }}" method="GET" style="display: none;">
          <input type="hidden" name="assignment_id" value="{{ assignment._id }}">
          <input type="hidden" name="classroom_id" value="{{ assignment.classroom_id }}">
          <input type="hidden" name="source" value="submission">
          <button type="submit" class="btn btn-outline-primary mt-3 w-full">ğŸ¬ Generate Video Submission</button>
        </form>
      {% endif %}
    </div>
  {% endif %}

  <!-- Navigation -->
  <div class="buttons mt-4">
    <a href="{{ url_for('boundary.download_assignment', assignment_id=assignment._id) }}" class="btn btn-primary" download>â¬‡ï¸ Download Assignment</a>
    <a href="{{ url_for('boundary.home') }}" class="btn btn-secondary">ğŸ  Return Home</a>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const fileRadio = document.getElementById("submit-file");
    const videoRadio = document.getElementById("submit-video");
    const fileForm = document.getElementById("file-form");
    const videoForm = document.getElementById("video-form");

    fileRadio.addEventListener("change", () => {
      fileForm.style.display = "block";
      videoForm.style.display = "none";
    });

    videoRadio.addEventListener("change", () => {
      fileForm.style.display = "none";
      videoForm.style.display = "block";
    });
  });
</script>

<style>
.assignment-view-container {
  text-align: center;
  padding: 20px;
}

.assignment-frame {
  margin: 20px auto;
  width: 80%;
  min-height: 300px;
  border: 1px solid #ddd;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  padding: 15px;
}

.text-content {
  background: #f9f9f9;
  border-radius: 8px;
  padding: 15px;
  text-align: left;
  white-space: pre-wrap;
}

.grade-feedback-box {
  background: #f8f9fa;
  border: 1px solid #ccc;
  border-radius: 10px;
  text-align: left;
  max-width: 600px;
  margin: 20px auto;
  padding: 20px;
}

.feedback-content {
  background: #fff;
  padding: 10px;
  border-left: 4px solid #007bff;
  margin-top: 8px;
  font-style: italic;
}

.submission-section {
  background: #1e1e1e;
  padding: 20px;
  border-radius: 12px;
  color: white;
}

.buttons {
  margin-top: 20px;
}

.btn {
  padding: 10px 20px;
  margin: 5px;
  border-radius: 5px;
  text-decoration: none;
  color: white;
}

.btn-primary { background-color: #007bff; }
.btn-secondary { background-color: #6c757d; }
.btn-success { background-color: #28a745; }
.btn-warning { background-color: #ffc107; color: black; }
.btn-danger { background-color: #dc3545; }
.btn-outline-primary {
  border: 2px solid #007bff;
  color: #007bff;
  background: transparent;
}
.btn-outline-primary:hover {
  background-color: #007bff;
  color: white;
}
</style>

{% endblock %}
